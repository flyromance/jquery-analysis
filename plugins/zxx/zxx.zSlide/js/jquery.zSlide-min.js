/*!
 * zSlide.js - JS for HTML5 Slide
 * Copyright (c) zhangxinxu
 * http://www.zhangxinxu.com/
 * 2011-12-28 基于HTML5 的幻灯片播放核心脚本
 * 2011-12-30 内置的弹框脚本
 * 2011-12-31 工具类功能
 * 2012-01-03 零星修复
 */
(function(a){a.extend({zSlide:{activeSlide:null,activeAnimate:null,arraySlide:[],arrayAnimate:[],indexSlide:0,indexAnimate:0,arrayTool:["Home","Time","Background","Prev","Index","Next"],timeLocalstorageKey:location.href.split("#")[0]+"zslTime",bgLocalstorageKey:location.href.split("#")[0]+"zslBg",visible:function(b,c){if(b){b.removeClass("zsl_slide_target")}if(a.browser.webkit){setTimeout(function(){location.replace(location.href.split("#")[0]+"#"+c.attr("id"))},350)}else{location.replace(location.href.split("#")[0]+"#"+c.attr("id"))}this.activeSlide=c.addClass("zsl_slide_target").trigger("slideload");this.indexSlide=c.data("indexSlide");this.process();return this},slide:function(){var e=this.arrayAnimate[this.indexAnimate],c=e&&e.attr("data-role"),b=this.arraySlide[this.indexSlide-1],d=this.arraySlide[this.indexSlide+1];indexActiveSlide=-1,indexActiveAnimate=-1;if(this.activeSlide){indexActiveSlide=this.activeSlide.data("index")}if(this.activeAnimate){indexActiveAnimate=this.activeAnimate.data("index")}if(c){if(c==="fade"){if(this.indexAnimate<indexActiveSlide){if(b){this.activeSlide.removeClass("in").addClass("out reverse");b.removeClass("out").addClass("in reverse");this.visible(this.activeSlide,b);b.find("[data-role='fade']").removeClass("out").addClass("in")}}else{if(this.indexAnimate>indexActiveAnimate){e.removeClass("out").addClass("in")}else{this.activeAnimate.removeClass("in").addClass("out")}}}else{if(c==="slide"){if(!this.activeSlide){}else{if(this.indexAnimate>indexActiveSlide){this.activeSlide.removeClass("in reverse").addClass("out");e.removeClass("out reverse").addClass("in")}else{if(this.indexAnimate<indexActiveSlide){this.activeSlide.removeClass("in").addClass("out reverse");e.removeClass("out").addClass("in reverse")}}}e.find("[data-role='fade']").removeClass("in out");this.visible(this.activeSlide,e)}}this.activeAnimate=e}return this},group:function(){var d=[],b=[],c=0;a("div[data-role='slide']").each(function(e){b.push(a(this).data("index",c));d.push(a(this).data("indexSlide",e));c++;a(this).find("[data-role='fade']").each(function(){b.push(a(this).data("index",c));c++})});this.arraySlide=d;this.arrayAnimate=b;return this},initIndex:function(){var c=location.href.split("#")[1],b=c&&a("#"+c);if(b&&b.size()){this.indexSlide=b.data("indexSlide")||0;this.indexAnimate=b.data("index")||0}else{this.indexSlide=0;this.indexAnimate=0}return this},process:function(){var c=this.indexSlide+1,b=this.arraySlide.length;if(c===b){this.eleProcess.html("&nbsp;").width("100%")}else{this.eleProcess.html(c).width(c/b*100+"%")}return this},element:function(){var d=a("div[data-role='header']").eq(0),c=a("div[data-role='footer']").eq(0);var e={Home:"回到起始页|!",Time:"定时提醒|c",Background:"更改背景|p",Prev:"往前播放|^",Index:"快速索引|(",Next:"向后播放|$"};if(d){this.eleHeader=d;this.eleTotal=a('<strong class="zsl_slide_total"></strong>').html(this.arraySlide.length);this.eleProcess=a('<strong class="zsl_progress"></strong>');this.eleHeader.append(this.eleProcess).append(this.eleTotal);this.process()}if(c){var b="";a.each(this.arrayTool,function(f,g){var h=e[g]&&e[g].split("|");if(h.length===2){b=b+'<a href="javascript:" class="zsl_tool" data-title="'+h[0]+'" data-key="'+g+'" data-role="tool">'+h[1]+"</a>"}});b=b+'<a href="http://www.zhangxinxu.com/wordpress/?p=2136" class="zsl_tool" data-title="使用帮助">d</a>';this.eleFooter=c;if(b){this.eleToolBar=a('<div class="zsl_tool_bar"></div>').html(b);this.eleFooter.append(this.eleToolBar)}}this.eleBody=a("body");return this},time:function(){var e=new Date().getTime(),d=this;var f=localStorage.getItem(this.timeLocalstorageKey);var c=[],g=[];if(f){c=f.split(",").sort();g=a.grep(c,function(j,h){return Number(j)>e})}if(!this.timeHasDetected){if(g.length){a.zDialog.confirm("主人，发现当前页面含有未完成的时间提醒，是否使用该时间提醒？",function(){localStorage.setItem(d.timeLocalstorageKey,g.join());d.time();a.zDialog.close()},function(){localStorage.removeItem(d.timeLocalstorageKey)})}d.timeHasDetected=true}else{if(c.length!==g.length){var b=Math.round((c[c.length-1]-c[0])/(1000*60));if(b===0){a.zDialog.alert("主人，时间到了，喵~~")}else{if(b<10){a.zDialog.alert("主人，只剩下"+b+"分钟了，要抓紧时间咯♥")}else{a.zDialog.alert("主人，还有"+b+"分钟❤")}}if(g.length){localStorage.setItem(d.timeLocalstorageKey,g.join())}else{localStorage.removeItem(d.timeLocalstorageKey)}}if(g.length){setTimeout(function(){d.time()},60000)}}return this},background:function(){var d=localStorage.getItem(this.bgLocalstorageKey),b=this.eleBody,c=new Image();if(d){if(/^data:image/.test(d)){b.css("backgroundImage","url("+d+")")}else{c.onload=function(){b.css("backgroundImage","url("+d+")")};c.onerror=function(){b.css("backgroundColor",d);b.css("backgroundImage","")};c.src=d}}return this},events:function(){var f=this.indexAnimate,b=this.arrayAnimate,c=this;var e=function(){if(f>=b.length){f=b.length-1;if(!a.zDialog.isOpen){a.zDialog.alert("主人，已经播放完毕了！")}}else{if(f<0){f=0;if(!a.zDialog.isOpen){a.zDialog.alert("主人，前面已经没有了！")}}else{c.indexAnimate=f;c.slide()}}};this.timerCursor=null;var d=0;a(document).bind({keyup:function(g){var h=g.keyCode;if(a.zDialog.isOpen){return false}if(h===34){f++;g.preventDefault();e()}else{if(h===33){f--;g.preventDefault();e()}}},mousemove:function(h){var g=h.pageX;if(Math.abs(g-d)>10){if(c.timerCursor){clearTimeout(c.timerCursor);c.eleBody.css("cursor","auto")}c.timerCursor=setTimeout(function(){c.eleBody.css("cursor","none")},3500);d=g}},dblclick:function(g){if(g.target.nodeName.toLowerCase()==="div"){c.eleFooter.toggle();c.eleHeader.toggle()}}});if(this.eleToolBar){this.eleToolBar.find("a[data-role='tool']").bind("click",function(){var h=a(this).attr("data-key");switch(h){case"Next":f++;e();break;case"Prev":f--;e();break;case"Index":var n='请选择：<select id="zDialogIndexSelect" class="zsl_dialog_index_select">';a.each(c.arraySlide,function(q,p){var s=p.data("index"),r=p.data("indexSlide");n=n+'<option value="'+s+'"'+(r===c.indexSlide?' selected="selected"':"")+">第"+(q+1)+"页</option>"});n+="</select>";a.zDialog.confirm(n,function(){f=a("#zDialogIndexSelect").val();e();a.zDialog.close()});break;case"Home":f=0;e();break;case"Time":var m='<p class="zsl_dialog_p">总时间：<input type="number" id="zDialogTimeTotal" class="zsl_dialog_time_input" /> 分钟(*)</p><p class="zsl_dialog_p">结束前：<input type="text" id="zDialogTimeRemind" class="zsl_dialog_time_input" title="多个时间可使用任意非数字字符分隔" /> 分钟提醒</p>';a.zDialog.confirm(m,function(){var r=a("#zDialogTimeTotal"),s=a("#zDialogTimeRemind"),v=a.trim(r.val()),u=a.trim(s.val()),w=parseInt(v,10),q=[],p=[];var t=new Date().getTime();if(r.size()&&s.size()){if(!w||w<1||w>720){r.get(0).focus();r.get(0).select();return false}else{if(u){p=u.match(/\d+/g)||[];q=a.map(p,function(x){return x<w?(w-x):null});q.push(w)}else{q.push(w)}localStorage.setItem(c.timeLocalstorageKey,a.map(q,function(x){return t+x*60*1000}).join());c.time()}}a.zDialog.close()});break;case"Background":var j='<div class="zsl_dialog_background"><p class="zsl_dialog_p"><input id="zslBgCustom" type="radio" name="zslBg" checked /><label for="zslBgCustom">自定义背景&emsp;</label> <input type="text" id="zslBgCustomText" size="22" /><label for="zslBgCustomText">（颜色值或url地址）</label></p><p class="zsl_dialog_p"><input id="zslBgLocalImage" type="radio" name="zslBg" /><label for="zslBgLocalImage">使用本地图片</label> <input type="file" id="zslBgLocalImageFile" disabled size="22" style="color: #fff;" /></p><p class="zsl_dialog_p"><input type="checkbox" id="zslBgRemember" checked="checked" /><label for="zslBgRemember">记住我的选择</label></p></div><div class="zsl_dialog_btn"><input type="button" id="zslBgSure" class="zsl_dialog_btn_ok" value="确定" /><input type="button" id="zslBgCancel" class="zsl_dialog_btn_no" value="取消" /></div>';var i="",g="",o="";var k=c.eleBody.css("backgroundImage"),l=c.eleBody.css("backgroundColor");a.zDialog.open({url:j,ajax:false,title:"修改背景",overlay:false,onShow:function(){var t=a("#zslBgCustom"),r=a("#zslBgLocalImage"),p=a("#zslBgCustomText"),s=a("#zslBgLocalImageFile"),q=a("#zslBgRemember");t.bind("click",function(){if(a(this).attr("checked")){p.removeAttr("disabled").trigger("change");s.attr("disabled","disabled")}});r.bind("click",function(){if(a(this).attr("checked")){s.removeAttr("disabled");p.attr("disabled","disabled");if(o){c.eleBody.css("backgroundImage","url("+o+")")}else{c.eleBody.css("backgroundColor",l);c.eleBody.css("backgroundImage",k)}}});p.bind("change",function(){var v=a(this).val(),u=new Image();if(v){u.onload=function(){c.eleBody.css("backgroundImage","url("+v+")")};u.onerror=function(){c.eleBody.css("backgroundColor",v);c.eleBody.css("backgroundImage","")};u.src=v;g=v}});s.bind("change",function(x){var w=x.target.files||x.dataTransfer.files,v=w[0];if(v.type.indexOf("image")==0){if(v.size>=512000){alert('主人，您这张"'+v.name+'"图片尺寸大了点，奴家消受不起，请小于500k.')}else{var u=new FileReader();u.onload=function(y){o=y.target.result;c.eleBody.css("backgroundImage","url("+o+")")};u.readAsDataURL(v)}}else{alert('主人，这个"'+v.name+'"不是图片，奴家无所适从了。')}});a("#zslBgSure").bind("click",function(){if(s.attr("disabled")){if(g){i=g}}else{if(o){i=o}}if(i){if(q.attr("checked")){localStorage.setItem(c.bgLocalstorageKey,i)}else{localStorage.removeItem(c.bgLocalstorageKey)}}a.zDialog.close()});a("#zslBgCancel").bind("click",function(){c.eleBody.css("backgroundColor",l);c.eleBody.css("backgroundImage",k);a.zDialog.close()})}}).position();break}return false})}a("a[href^='#']").bind("click",function(){location.replace(location.href.split("#")[0]+a(this).attr("href"));c.initIndex().slide();f=c.indexAnimate;return false});return this},init:function(){this.group().initIndex().element().events().slide().background().time()}},zDialog:{open:function(b){var c={url:"",ajax:true,ajaxData:{},overlay:true,closable:false,title:"",pageContainer:a("body"),onShow:a.noop,onClose:a.noop};this.options=a.extend(c,b||{});this.remove().init().get();return this},alert:function(d,f,c){var b=this;c=c||{};var e={url:'<div class="zsl_dialog_alert">'+d+'</div><p class="zsl_dialog_btn"><input type="button" id="zDialogBtnOk" class="zsl_dialog_btn_ok" value="确定" /></p>',ajax:false};c=a.extend(c,e);this.open(c);this.btnOk=a("#zDialogBtnOk");this.btnOk.bind("click",function(){if(a.isFunction(f)){f.call(this,b)}b.close()});if(this.btnOk.size()){this.btnOk.get(0).focus()}return this},confirm:function(f,e,b,d){var c=this;d=d||{};var g={url:'<div class="zsl_dialog_confirm">'+f+'</div><p class="zsl_dialog_btn"><input type="button" id="zDialogBtnOk" class="zsl_dialog_btn_ok" value="确定" /><input type="button" id="zDialogBtnNo" class="zsl_dialog_btn_no" value="取消" /></p>',ajax:false};d=a.extend(d,g);this.open(d);this.btnOk=a("#zDialogBtnOk");this.btnNo=a("#zDialogBtnNo");this.btnOk.bind("click",function(){if(a.isFunction(e)){e.call(this,c)}});this.btnNo.bind("click",function(){if(a.isFunction(b)){b.call(this,c)}c.close()});if(this.btnOk.size()){this.btnOk.get(0).focus()}return this},remind:function(c,b){var d={url:'<div class="zsl_dialog_remind">'+c+"</div>",ajax:false};this.open(a.extend(b||{},d));return this},loading:function(b){var c={url:'<div class="zsl_dialog_loading">加载中...</div>',ajax:false};this.open(a.extend(b||{},c))},get:function(){var b=this;if(this.options.ajax){this.loading();a.ajax({url:this.options.url,data:this.options.ajaxData||{},error:function(){b.alert("加载嗝屁啦，仔细检查检查吧！")},success:function(c){b.content=c;b.show()}})}else{this.content=a(this.options.url);this.show()}return this},position:function(){a.zDialog.box.css({marginLeft:a.zDialog.box.width()/2*-1,marginTop:a.zDialog.box.height()/2*-1});return this},show:function(){this.options.pageContainer=this.options.pageContainer||document.body;if(this.options.closable&&window.screenX){this.body.append(this.shut)}if(this.options.title){this.body.append(this.title)}this.box.append(this.body.append(this.content));this.options.pageContainer.append(this.box.addClass("in"));if(this.overlay){this.options.pageContainer.append(this.overlay)}if(a.isFunction(this.options.onShow)){this.options.onShow.call(this)}this.isOpen=true;return this},close:function(){var b=this;if(this.box){this.box.removeClass("in").addClass("out reverse")}if(this.overlay){this.overlay.css("opacity",0)}setTimeout(function(){b.remove()},300);if(a.isFunction(this.options.onClose)){this.options.onClose.call(this)}},remove:function(){if(this.box){this.box.remove()}if(this.overlay){this.overlay.remove()}this.isOpen=false;return this},init:function(){this.body=a('<div class="zsl_dialog_body"></div>');if(this.options.overlay){this.box=a('<div class="zsl_dialog pop"></div>');this.overlay=a('<div class="zsl_overlay"></div>')}else{this.box=a('<div class="zsl_dialog pop"></div>');this.overlay=null}if(this.options.closable){this.shut=a('<a href="javascript:" class="zsl_dialog_close" title="关闭该弹框">x</a>').bind("click",function(){this.close()}.bind(this))}if(this.options.title){this.title=a('<h2 class="zsl_dialog_title">'+this.options.title+"</h2>")}return this}}})})(jQuery);